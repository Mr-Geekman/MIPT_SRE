# ДЗ-2

## Как открыть страницу

Для получения доступа к странице с Prometheus требуется подключиться к виртуальной машине по ssh с пробрасыванием портов.

Пример:
```bash
ssh sre-course -L 9090:127.0.0.1:9090
```

Тогда на `localhost:9090` вы сможете увидеть работающий Prometheus.

Для настройки файрвола была использована утилита ufw, [туториал](https://www.digitalocean.com/community/tutorials/ufw-essentials-common-firewall-rules-and-commands).

## Решение

### Установка Prometheus

Для этого достаточно выполнить инструкцию из `TASK.pdf`. Указанный конфиг уже позволяет мониторить Prometheus.

Проверить этот пункт можно если открыть в браузере `localhost:9090` и изучить конфиг/метрики.

### Использование PromQL

Посмотрим на некоторые запросы и поясним, что они делают.

1. Булевый индикатор того, что 0.9 квантиль вычисления PromQL запроса не превышает 0.05с. Если 0, то это значит, что в не менее чем 90% случаев мы работаем быстрее, чем за 0.05с.
```
prometheus_engine_query_duration_seconds{slice="inner_eval", quantile="0.9"} > bool 0.05
```
2. Среднее количество успешных ответов в минуту (код 200) по запросам к API с усреднением за 15м.
```
sum(rate(prometheus_http_requests_total{code="200", handler=~"/api/v1/.*"}[15m])*60)
```
3. Максимальное количество запросов к API в минуту за последние 15м.
```
max_over_time(sum(rate(prometheus_http_requests_total{code="200", handler=~"/api/v1/.*"}[1m]))[15m:1m]) * 60
```

### Использование recording rule

1. Запишем recording rule для 3-го запроса из пункта выше, см. `rules.yml`.
2. Скопируем его в `etc/prometheus` и перезапустим сервис.
3. Проверяем, что по ключу `max_num_api_queries_last_15_min` метрика существует.
