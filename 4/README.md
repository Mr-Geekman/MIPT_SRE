# ДЗ-4

## Как открыть страницу

Для получения доступа к странице с Prometheus требуется подключиться к виртуальной машине по ssh с пробрасыванием портов.

Пример:
```bash
ssh sre-course -L 9090:127.0.0.1:9090
```

Тогда на `localhost:9090` вы сможете увидеть работающий Prometheus.

Для настройки файрвола была использована утилита ufw, [туториал](https://www.digitalocean.com/community/tutorials/ufw-essentials-common-firewall-rules-and-commands).

## Решение

### Контекст подготовки метрик

Мы команда, отвечающая за поддержку OnCall для других SRE-команд компании. Представим, что на нашем сервисе работают 10 команд.

### Выбор SLI

#### 1. Проверка доли пользователей без контактов

Мы хотим, чтобы у участников команд были указаны контакты. Если контактов нет, то надо об этом сигнализировать.

Считаем долю пользователей, в которых не указаны контакты.

#### 2. Проверка для каждой команды наличие primary дежурного

В каждый момент времени мы ожидаем, что в каждой команде присутствует primary дежурный. 

Если в данный момент для всех команд такой дежурный есть, то к сумме успешных случаев прибавляем 1, иначе прибавляем 0.
Параллельно считаем количество всех случаев.

#### 3. Готовность к повышенной нагрузке во время сбоев.

Во время сбоев количество запросов на OnCall может значительно увеличиться. 
Поэтому имеет смысл смотреть на то сколько "вычислительных" запасов у нас есть для того, чтобы адекватно справиться с повышенной нагрузкой во время инцидента.

Что считаем:
```
1 / (quantile_over_time(0.5, node_load15[1d]) + 1e-3)
```
1. Берем 15-минутную нагрузку за последний день.
2. Считаем медиану нагрузки.
3. Берем обратную величину. 
4. Если сервис работает в больше, чем одном процессе, то вместо 1 в числителе надо поставить общее число доступных процессов.

Тем самым получаем во сколько раз более высокую нагрузку мы могли бы выдержать в этот день.

### Проектирование экспортера

Для посдчета первых двух метрик напишем экспортер: см. директорию `exporter`.

Затем мы переносим его на ноду и запускаем systemd сервис с этим скриптом.

Для подсчета метрики 3 ничего делать не нужно -- это выражение можно уже вычислить в prometheus.

### Фиксирование SLO

1. Доля пользователей без контактов: <= 0.05
    
    Представим ситуацию: имеем 10 команд, т.е. 10 primary дежурных. Среди них 5% не имеют контактов. 
    Получаем вероятность, что у всех из них есть контакты: 60%.
    Для сравнения, если возьмем не 5%, а 10%, то эта вероятность упадет до 35%, т.е. чуть больше одной трети.
2. Доля времени, когда есть команды без primary дежурного в течение дня: < 0.02

    Без наличия дежурного теряется смысл сервиса, а потому этот индикатор очень важен. 
    Если берем 0.02, то закладываем примерно 30 минут в день на ситуацию, когда нет хотя бы одного дежурного.

3. Запас по производительности: >= 5

    Предполагаем, что в случае больших сбоев на наш сервис одновременно может зайти много команд, поэтому оставляем большой запас в 5 раз.

### Видеоотчет

В демонстрации был использован код из `demo.sh`.

[Запись](https://disk.yandex.ru/i/mYWbaIKsC9U1QA).
